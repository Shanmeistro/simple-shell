---
- name: Setup custom shell environment
  hosts: localhost
  connection: local
  become: false
  vars:
    user_home: "{{ ansible_env.HOME }}"
    config_dir: "{{ user_home }}/.config"
    local_bin_dir: "{{ user_home }}/.local/bin"

    # Starship configuration file path
    starship_config_path: "{{ config_dir }}/starship.toml"

    # P10k configuration file path
    p10k_config_path: "{{ user_home }}/.p10k.zsh"

    # Oh My Zsh path
    omz_path: "{{ user_home }}/.oh-my-zsh"
    omz_custom_path: "{{ omz_path }}/custom"
    omz_themes_path: "{{ omz_custom_path }}/themes"
    p10k_theme_path_omz: "{{ omz_themes_path }}/powerlevel10k"

  tasks:
    - name: Install common utilities and prepare directories
      ansible.builtin.include_role:
        name: common

    - name: Install and configure shell environment with chosen framework
      ansible.builtin.include_role:
        name: shell
      when: shell_name is defined and prompt_framework is defined

    - name: Install nerd-fonts if on Linux or MacOS
      ansible.builtin.include_role:
        name: fonts
      when: ansible_facts['os_family'] in ['Debian', 'RedHat', 'Darwin'] and shell_name is defined

    - name: Install optional sysadmin tools
      ansible.builtin.include_role:
        name: sysadmin-tools
      when: install_optional_tools is defined and install_optional_tools

    - name: Install optional development tools
      ansible.builtin.include_role:
        name: dev-tools
      when: install_dev_tools is defined and install_dev_tools

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Shell environment setup completed successfully!

          Configured:
          - Shell: {{ shell_name | default('not specified') }}
          - Framework: {{ prompt_framework | default('not specified') }}
          {% if starship_template is defined %}
          - Starship template: {{ starship_template }}
          {% endif %}
          {% if p10k_template is defined %}
          - Powerlevel10k template: {{ p10k_template }}
          {% endif %}

          Additional configuration scripts:
          - Font installation: ./manage_fonts.sh
          - Optional tools: ./manage_optional_tools.sh
      when: shell_name is defined

  tags:
    - common
    - shell
    - fonts
    - sysadmin_tools
    - devtools
